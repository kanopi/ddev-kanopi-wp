#!/usr/bin/env bash
#ddev-generated

## Description: Initialize/reinstall tools needed for critical CSS.
## Usage: critical-install
## Example: ddev critical-install
## Aliases: install-critical-tools,cri,critical:install

#-------------------------- Helper functions -----------------------------------

green='\033[0;32m'
yellow='\033[1;33m'
NC='\033[0m'

divider='===================================================\n'
check='\xE2\x9C\x85'
construction='\xF0\x9F\x9A\xA7'
crossmark='\xE2\x9D\x8C'
hospital='\xF0\x9F\x8F\xA5'
party='\xF0\x9F\x8E\x88 \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x8A'
reverseparty='\xF0\x9F\x8E\x8A \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x88'
rocket='\xF0\x9F\x9A\x80'
silhouette='\xF0\x9F\x91\xA4'
lightning='\xE2\x9A\xA1'
drop='\xF0\x9F\x92\xA7'
shark='\xF0\x9F\xA6\x88'
gear='\xEF\xB8\x8F'
critical_command='ddev critical:run'

#-------------------------- Settings -------------------------------------------

# Get theme configuration from environment variables
THEME_PATH=$(printenv THEME 2>/dev/null || echo "wp-content/themes/custom/struts")
DOCROOT=$(printenv DOCROOT 2>/dev/null || echo "web")

# Define full theme path
FULL_THEME_PATH="/var/www/html/${DOCROOT}/${THEME_PATH}"

#-------------------------- Execution ------------------------------------------

# Abort if anything fails
set -e

# Critical CSS dependencies verification
echo -e "\n ${hospital} ${yellow} Verifying Critical CSS dependencies${NC} ${hospital}"
echo -e "${green}${divider}${NC}"

# Check if chromium is installed (indicates webimage_extra_packages are configured)
if ! command -v chromium &> /dev/null; then
    echo -e "\n${yellow}Warning: Chromium not found.${NC}"
    echo -e "Critical CSS packages should be pre-installed via webimage_extra_packages."
    echo -e "${yellow}Please run 'ddev restart' to install required packages.${NC}"
    echo ""
    echo "If issues persist, check that webimage_extra_packages is configured in .ddev/config.yaml"
    echo "The addon should have added these automatically during installation."
    exit 1
fi

echo -e "\n${check} ${green}Critical CSS dependencies verified${NC}"

# Check if theme directory exists
if [ ! -d "${FULL_THEME_PATH}" ]; then
    echo -e "\n${yellow}Theme directory not found: ${FULL_THEME_PATH}${NC}"
    echo -e "Please ensure your theme is located at the correct path or update THEME environment variable in .ddev/config.yaml"
    exit 1
fi

# Move to the theme.
echo -e "\n ${rocket} ${yellow} To the theme!${NC} ${rocket}"
echo -e "${yellow} ${FULL_THEME_PATH}${NC}"
echo -e "${green}${divider}${NC}"
cd ${FULL_THEME_PATH}

# Runs NPM Install.
echo -e "\n ${construction} ${yellow} Install NPM${NC} ${construction}"
echo -e "${green}${divider}${NC}"
source ~/.nvm/nvm.sh
source ~/.bashrc
echo "NVM version: $(nvm --version)"

# Use Node version specified in .nvmrc
if [ -f "${FULL_THEME_PATH}/.nvmrc" ]; then
    NODE_VERSION=$(cat ${FULL_THEME_PATH}/.nvmrc)
    echo "Theme node version: ${NODE_VERSION}"
    nvm install ${NODE_VERSION}
    nvm alias default ${NODE_VERSION}
    nvm use
else
    echo "No .nvmrc found, using default Node version"
    nvm use default || nvm use node
fi

npm ci --save patch-package

# Finish.
echo -e "\n${party} ${yellow} Critical CSS Tools installed.${NC} ${reverseparty}"
echo -e "${NC}Run ${yellow}${critical_command}${NC} to compile critical css.${NC}"
echo -e "${green}${divider}${NC}"
