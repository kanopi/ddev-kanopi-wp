#!/usr/bin/env bash

## Refresh DB
## Description: Downloads the database from the hosting provider. Supports Pantheon, WPEngine, and Kinsta platforms.
## Usage: db-refresh [environment id]
## Example: ddev db-refresh pr-123
## Aliases: refresh,db:refresh
## Flags: [{"Name":"force","Shorthand":"f","Usage":"Force creation of new backup regardless of age"}]

green='\033[0;32m'
yellow='\033[1;33m'
red='\033[0;31m'
NC='\033[0m'

# Parse command line arguments
FORCE_BACKUP=false
# Get hosting environment from environment variable, default based on provider
ENVIRONMENT="$HOSTING_ENV"
if [ -z "$ENVIRONMENT" ]; then
  if [[ "$HOSTING_PROVIDER" == "pantheon" ]]; then
    ENVIRONMENT="dev"
  elif [[ "$HOSTING_PROVIDER" == "wpengine" ]]; then
    ENVIRONMENT="$HOSTING_SITE"
  elif [[ "$HOSTING_PROVIDER" == "kinsta" ]]; then
    ENVIRONMENT="live"
  else
    ENVIRONMENT="dev"
  fi
fi

for arg in "$@"; do
  case $arg in
    --force|-f)
      FORCE_BACKUP=true
      shift
      ;;
    *)
      # Skip DDEV internal parameters (like "2") and set environment if valid
      if [ "$arg" != "2" ] && [ -z "$ENVIRONMENT_SET" ]; then
        ENVIRONMENT="$arg"
        ENVIRONMENT_SET=true
      fi
      shift
      ;;
  esac
done

cd ${DDEV_APPROOT}

# Get the hosting provider
HOSTING_PROVIDER="${HOSTING_PROVIDER:-pantheon}"

echo -e "\n${yellow}Refreshing database from ${HOSTING_PROVIDER} environment: ${ENVIRONMENT}${NC}"

# Platform-specific database refresh
if [[ "$HOSTING_PROVIDER" == "pantheon" ]]; then
  echo -e "${green}Using Pantheon refresh script...${NC}"
  # Call the Pantheon-specific refresh script
  bash .ddev/scripts/pantheon-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
elif [[ "$HOSTING_PROVIDER" == "wpengine" ]]; then
  echo -e "${green}Using WPEngine refresh script...${NC}"
  # Call the WPEngine-specific refresh script
  bash .ddev/scripts/wpengine-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
elif [[ "$HOSTING_PROVIDER" == "kinsta" ]]; then
  echo -e "${green}Using Kinsta refresh script...${NC}"
  # Call the Kinsta-specific refresh script
  bash .ddev/scripts/kinsta-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
else
  echo -e "${red}Hosting platform '$HOSTING_PROVIDER' not supported${NC}"
  echo -e "${yellow}Supported platforms: pantheon, wpengine, kinsta${NC}"
  exit 1
fi

echo -e "\n${green}Database refresh completed successfully!${NC}"
