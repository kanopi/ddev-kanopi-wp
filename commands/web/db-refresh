#!/usr/bin/env bash
#ddev-generated

## Refresh DB
## Description: Downloads the database from the hosting provider. Supports Pantheon, WPEngine, and Kinsta platforms.
## Usage: db-refresh [environment id]
## Example: ddev db-refresh pr-123
## Aliases: refresh,db:refresh
## Flags: [{"Name":"force","Shorthand":"f","Usage":"Force creation of new backup regardless of age"}]

green='\033[0;32m'
yellow='\033[1;33m'
red='\033[0;31m'
NC='\033[0m'

# Parse command line arguments
FORCE_BACKUP=false
# Get hosting environment from environment variable, default based on provider
ENVIRONMENT="$HOSTING_ENV"
if [ -z "$ENVIRONMENT" ]; then
  if [[ "$HOSTING_PROVIDER" == "pantheon" ]]; then
    ENVIRONMENT="dev"
  elif [[ "$HOSTING_PROVIDER" == "wpengine" ]]; then
    ENVIRONMENT="$HOSTING_SITE"
  elif [[ "$HOSTING_PROVIDER" == "kinsta" ]]; then
    ENVIRONMENT="live"
  else
    ENVIRONMENT="dev"
  fi
fi

for arg in "$@"; do
  case $arg in
    --force|-f)
      FORCE_BACKUP=true
      shift
      ;;
    *)
      # Skip DDEV internal parameters (like "2") and set environment if valid
      if [ "$arg" != "2" ] && [ -z "$ENVIRONMENT_SET" ]; then
        ENVIRONMENT="$arg"
        ENVIRONMENT_SET=true
      fi
      shift
      ;;
  esac
done

cd ${DDEV_APPROOT}

# Get the hosting provider
HOSTING_PROVIDER="${HOSTING_PROVIDER:-pantheon}"

# Check if hosting provider is properly configured before attempting refresh
PROVIDER_CONFIGURED=false

case "${HOSTING_PROVIDER}" in
    "pantheon")
        HOSTING_SITE_VALUE=$(printenv HOSTING_SITE 2>/dev/null || echo "")
        if [ -n "$HOSTING_SITE_VALUE" ]; then
            PROVIDER_CONFIGURED=true
        else
            echo -e "${red}Error: HOSTING_SITE not configured for Pantheon. Run 'ddev project-configure' to set up your Pantheon configuration.${NC}"
            exit 1
        fi
        ;;
    "wpengine")
        HOSTING_SITE_VALUE=$(printenv HOSTING_SITE 2>/dev/null || echo "")
        if [ -n "$HOSTING_SITE_VALUE" ]; then
            PROVIDER_CONFIGURED=true
        else
            echo -e "${red}Error: HOSTING_SITE not configured for WPEngine. Run 'ddev project-configure' to set up your WPEngine configuration.${NC}"
            exit 1
        fi
        ;;
    "kinsta")
        REMOTE_HOST_VALUE=$(printenv REMOTE_HOST 2>/dev/null || echo "")
        if [ -n "$REMOTE_HOST_VALUE" ]; then
            PROVIDER_CONFIGURED=true
        else
            echo -e "${red}Error: REMOTE_HOST not configured for Kinsta. Run 'ddev project-configure' to set up your Kinsta SSH configuration.${NC}"
            exit 1
        fi
        ;;
    *)
        # Fallback to old behavior for backward compatibility
        HOSTING_SITE_VALUE=$(printenv HOSTING_SITE 2>/dev/null || echo "")
        if [ -n "$HOSTING_SITE_VALUE" ]; then
            PROVIDER_CONFIGURED=true
        else
            echo -e "${red}Error: No hosting provider configuration found. Run 'ddev project-configure' to set up your hosting configuration.${NC}"
            exit 1
        fi
        ;;
esac

if [ "$PROVIDER_CONFIGURED" = true ]; then
    echo -e "\n${yellow}Refreshing database from ${HOSTING_PROVIDER} environment: ${ENVIRONMENT}${NC}"
else
    echo -e "${red}Hosting provider configuration not found. Please run 'ddev project-configure' first.${NC}"
    exit 1
fi

# Platform-specific database refresh
if [[ "$HOSTING_PROVIDER" == "pantheon" ]]; then
  echo -e "${green}Using Pantheon refresh script...${NC}"
  # Call the Pantheon-specific refresh script
  bash .ddev/scripts/pantheon-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
elif [[ "$HOSTING_PROVIDER" == "wpengine" ]]; then
  echo -e "${green}Using WPEngine refresh script...${NC}"
  # Call the WPEngine-specific refresh script
  bash .ddev/scripts/wpengine-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
elif [[ "$HOSTING_PROVIDER" == "kinsta" ]]; then
  echo -e "${green}Using Kinsta refresh script...${NC}"
  # Call the Kinsta-specific refresh script
  bash .ddev/scripts/kinsta-refresh.sh "$ENVIRONMENT" "$FORCE_BACKUP"
else
  echo -e "${red}Hosting platform '$HOSTING_PROVIDER' not supported${NC}"
  echo -e "${yellow}Supported platforms: pantheon, wpengine, kinsta${NC}"
  exit 1
fi

# Restore admin user after database refresh
echo -e "${yellow}Restoring WordPress admin user...${NC}"
if command -v wp-restore-admin-user >/dev/null 2>&1; then
    wp-restore-admin-user
else
    echo -e "${yellow}wp-restore-admin-user command not available, skipping admin user restoration${NC}"
fi

echo -e "\n${green}Database refresh completed successfully!${NC}"
