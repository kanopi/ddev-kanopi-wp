#!/bin/bash

## Description: Interactive reconfiguration wizard for Kanopi WordPress DDEV
## Usage: configure
## Example: "ddev configure"

#ddev-generated

# Colors and formatting
green='\033[0;32m'
yellow='\033[1;33m'
red='\033[0;31m'
NC='\033[0m'
divider='===================================================\n'

echo -e "\nüîß ${yellow}Kanopi WordPress DDEV Reconfiguration Wizard${NC} üîß"
echo -e "${green}${divider}${NC}"
echo "This tool allows you to reconfigure your existing DDEV environment."
echo "Environment variables will be updated in .ddev/config.yaml"
echo "Press Ctrl+C anytime to exit."
echo ""

# Check if DDEV project exists
if [ ! -f ".ddev/config.yaml" ]; then
    echo "‚ùå DDEV project not found. Please run this command from your DDEV project root."
    echo "üí° If this is a new project, run 'ddev add-on get kanopi/ddev-kanopi-wp' instead."
    exit 1
fi

# Check if Kanopi add-on is installed
if ! ddev exec printenv HOSTING_PROVIDER >/dev/null 2>&1; then
    echo "‚ùå Kanopi WordPress add-on environment not found."
    echo "Please run 'ddev add-on get kanopi/ddev-kanopi-wp' first"
    exit 1
fi

# Function to prompt for input with default
prompt_input() {
    local prompt="$1"
    local default="$2"
    local var_name="$3"
    
    if [ -n "$default" ]; then
        echo -n "$prompt [$default]: "
    else
        echo -n "$prompt: "
    fi
    
    read -r input
    if [ -z "$input" ] && [ -n "$default" ]; then
        input="$default"
    fi
    
    eval "$var_name='$input'"
}

# Function to select from options
select_option() {
    local prompt="$1"
    shift
    local options=("$@")
    
    printf "%s\n" "$prompt" >&2
    for i in "${!options[@]}"; do
        printf "  %d. %s\n" "$((i+1))" "${options[i]}" >&2
    done
    printf "Select option [1]: " >&2
    
    read -r choice
    choice=${choice:-1}
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#options[@]}" ]; then
        echo "${options[$((choice-1))]}"
    else
        echo "${options[0]}"
    fi
}

# Show current configuration
echo "üìã Current Configuration:"
echo "------------------------"
CURRENT_PROVIDER=$(ddev exec printenv HOSTING_PROVIDER 2>/dev/null || echo "not set")
CURRENT_SITE=$(ddev exec printenv HOSTING_SITE 2>/dev/null || echo "not set")
CURRENT_ENV=$(ddev exec printenv HOSTING_ENV 2>/dev/null || echo "not set")
CURRENT_THEME=$(ddev exec printenv THEME 2>/dev/null || echo "not set")
CURRENT_THEMENAME=$(ddev exec printenv THEMENAME 2>/dev/null || echo "not set")
CURRENT_WP_USER=$(ddev exec printenv WP_ADMIN_USER 2>/dev/null || echo "not set")
CURRENT_WP_EMAIL=$(ddev exec printenv WP_ADMIN_EMAIL 2>/dev/null || echo "not set")
CURRENT_MIGRATE_SOURCE=$(ddev exec printenv MIGRATE_DB_SOURCE 2>/dev/null || echo "not set")
CURRENT_MIGRATE_ENV=$(ddev exec printenv MIGRATE_DB_ENV 2>/dev/null || echo "not set")

echo "Hosting Provider: $CURRENT_PROVIDER"
echo "Site: $CURRENT_SITE"
echo "Environment: $CURRENT_ENV"
echo "Theme Path: $CURRENT_THEME"
echo "Theme Name: $CURRENT_THEMENAME"
echo "WordPress Admin User: $CURRENT_WP_USER"
echo "WordPress Admin Email: $CURRENT_WP_EMAIL"
echo "Migration Source: $CURRENT_MIGRATE_SOURCE"
echo "Migration Environment: $CURRENT_MIGRATE_ENV"
echo ""

# Get hosting provider
echo "üèõÔ∏è Hosting Provider Configuration:"
echo "----------------------------------"
HOST_PROVIDER=$(select_option "Select your hosting provider:" "pantheon" "wpengine" "kinsta")
echo "‚úì Selected: $HOST_PROVIDER"

# Get hosting-specific configuration
echo ""
case "$HOST_PROVIDER" in
    "pantheon")
        echo "üèõÔ∏è Pantheon Configuration:"
        echo "--------------------------"
        prompt_input "Site machine name (e.g., my-site)" "$CURRENT_SITE" HOSTING_SITE
        prompt_input "Default environment" "${CURRENT_ENV:-dev}" HOSTING_ENV
        ;;
    "wpengine")
        echo "‚ö° WPEngine Configuration:"
        echo "-------------------------"
        prompt_input "Install name (e.g., my-site)" "$CURRENT_SITE" HOSTING_SITE
        prompt_input "Default environment" "${CURRENT_ENV:-production}" HOSTING_ENV
        ;;
    "kinsta")
        echo "üî∑ Kinsta Configuration:"
        echo "-----------------------"
        prompt_input "Site name (e.g., my-site)" "$CURRENT_SITE" HOSTING_SITE
        prompt_input "Default environment" "${CURRENT_ENV:-live}" HOSTING_ENV
        ;;
esac

# Get theme configuration
echo ""
echo "üé® Theme Configuration:"
echo "----------------------"
prompt_input "Theme path (e.g., wp-content/themes/custom/mytheme)" "$CURRENT_THEME" THEME_PATH
prompt_input "Theme name/slug (e.g., mytheme)" "$CURRENT_THEMENAME" THEME_NAME

# Get WordPress admin configuration
echo ""
echo "üë§ WordPress Admin Configuration:"
echo "--------------------------------"
prompt_input "WordPress admin username" "${CURRENT_WP_USER:-admin}" WP_ADMIN_USER

# Get password securely
echo -n "WordPress admin password: "
read -s WP_ADMIN_PASS
echo ""
echo -n "Confirm password: "
read -s WP_ADMIN_PASS_CONFIRM
echo ""

if [ "$WP_ADMIN_PASS" != "$WP_ADMIN_PASS_CONFIRM" ]; then
    echo "‚ö†Ô∏è  Passwords don't match. Using default."
    WP_ADMIN_PASS="admin"
fi

prompt_input "WordPress admin email" "${CURRENT_WP_EMAIL:-admin@example.com}" WP_ADMIN_EMAIL

# Get migration settings (optional)
echo ""
echo "üîÑ Migration Settings (optional):"
echo "---------------------------------"
prompt_input "Source site for migrations (optional)" "$CURRENT_MIGRATE_SOURCE" MIGRATE_SOURCE
if [ -n "$MIGRATE_SOURCE" ]; then
    prompt_input "Source environment" "${CURRENT_MIGRATE_ENV:-live}" MIGRATE_ENV
fi

# Get plugin licenses
echo ""
echo "üîë Premium Plugin Licenses (optional):"
echo "--------------------------------------"
prompt_input "ACF Pro license key" "" ACF_LICENSE
prompt_input "Gravity Forms license key" "" GF_LICENSE

# Update configuration
echo ""
echo "üíæ Updating configuration..."

# Stop DDEV to safely update configuration
echo "Stopping DDEV to update configuration..."
ddev stop

# Update environment variables in .ddev/config.yaml
echo "Setting hosting provider environment variables..."
ddev config --web-environment-add HOSTING_PROVIDER="$HOST_PROVIDER"
ddev config --web-environment-add HOSTING_SITE="$HOSTING_SITE"
ddev config --web-environment-add HOSTING_ENV="$HOSTING_ENV"

# Update theme environment variables
echo "Setting theme environment variables..."
ddev config --web-environment-add THEME="$THEME_PATH"
ddev config --web-environment-add THEMENAME="$THEME_NAME"

# Update WordPress admin environment variables
echo "Setting WordPress admin environment variables..."
ddev config --web-environment-add WP_ADMIN_USER="$WP_ADMIN_USER"
ddev config --web-environment-add WP_ADMIN_PASS="$WP_ADMIN_PASS"
ddev config --web-environment-add WP_ADMIN_EMAIL="$WP_ADMIN_EMAIL"

# Update migration settings if provided
if [ -n "$MIGRATE_SOURCE" ]; then
    echo "Setting migration environment variables..."
    ddev config --web-environment-add MIGRATE_DB_SOURCE="$MIGRATE_SOURCE"
    ddev config --web-environment-add MIGRATE_DB_ENV="$MIGRATE_ENV"
fi

# Note: Plugin licenses are no longer managed by this add-on

# Start DDEV with new configuration
echo "Starting DDEV with updated configuration..."
ddev start

echo ""
echo -e "üéâ ${green}Reconfiguration complete!${NC}"
echo ""
echo "üìÅ All settings updated as environment variables in: .ddev/config.yaml"
echo ""
echo -e "${yellow}Next steps:${NC}"

# Provider-specific authentication setup
case "$HOST_PROVIDER" in
    "pantheon")
        echo "1. üîë Set your Pantheon machine token globally (if not already set):"
        echo "   ddev config global --web-environment-add=TERMINUS_MACHINE_TOKEN=your_token"
        echo "   üí° Get your token: https://dashboard.pantheon.io/machine-token/create"
        echo ""
        ;;
    "wpengine")
        echo "1. üîë Set your WPEngine SSH credentials globally (if needed):"
        echo "   üí° Ensure your SSH key is added to your WPEngine account"
        echo "   üí° Run: ddev auth ssh (to start SSH agent)"
        echo ""
        ;;
    "kinsta")
        echo "1. üîë Set your Kinsta API credentials globally (if needed):"
        echo "   ddev config global --web-environment-add=KINSTA_API_KEY=your_api_key"
        echo "   ddev config global --web-environment-add=KINSTA_SSH_HOST=your.server.ip"
        echo "   ddev config global --web-environment-add=KINSTA_SSH_PORT=your_port"
        echo "   ddev config global --web-environment-add=KINSTA_SSH_USER=your_user"
        echo "   üí° Get API key: https://my.kinsta.com/api-keys"
        echo ""
        ;;
esac

echo "2. üóÑÔ∏è Refresh your database from $HOST_PROVIDER:"
echo "   ddev refresh"
echo ""
echo "3. üé® Install theme development tools (if needed):"
echo "   ddev install-theme-tools"
echo ""
echo "4. üåê Start developing:"
echo "   ddev development"
echo ""
echo -e "${green}${divider}${NC}"