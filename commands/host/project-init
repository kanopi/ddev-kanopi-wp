#!/usr/bin/env bash

## Description: Initialize local WordPress development environment.
## Usage: project-init
## Example: "ddev project-init"
## Aliases: init,project:init

#ddev-generated

#-------------------------- Helper functions ------------------------------

green='\033[0;32m'
yellow='\033[1;33m'
NC='\033[0m'

divider='===================================================\n'
check='\xE2\x9C\x85'
construction='\xF0\x9F\x9A\xA7'
crossmark='\xE2\x9D\x8C'
party='\xF0\x9F\x8E\x88 \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x8A'
reverseparty='\xF0\x9F\x8E\x8A \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x88'
rocket='\xF0\x9F\x9A\x80'
lightning='\xE2\x9A\xA1'
gear='\xEF\xB8\x8F'
key='\xF0\x9F\x94\x91'
lock='\xF0\x9F\x94\x92'
arm='\xF0\x9F\x92\xAA'

# WordPress-specific commands
theme_dev_command='ddev theme-watch'
theme_build_command='ddev theme-build'
refresh_command='ddev db-refresh'

# Get docroot from DDEV configuration, default to 'web'
DOCROOT=$(grep '^docroot:' .ddev/config.yaml 2>/dev/null | cut -d: -f2 | tr -d ' ' || true)

# Define paths
MU_PLUGINS_PATH="${DOCROOT}/wp-content/mu-plugins"

#-------------------------- Execution -------------------------------------

echo -e "\n${rocket} ${yellow} Initializing the Project.${NC} ${rocket}"
echo -e "${green}${divider}${NC}"
ddev start -y

# Set up Lefthook.
ddev project-lefthook

# Add SSH keys for remote access.
ddev project-auth

# Check for auth.json in project root
check_auth() {
  if [ ! -f "auth.json" ]; then
    echo "⚠️  No auth.json found in project root"
    echo ""
    echo "   This file is required for authenticating with private packages:"
    echo "   - GitHub token (for private repos)"
    echo "   - ACF Pro credentials"
    echo "   - Yoast Premium credentials"
    echo ""
    echo "   You can retrieve this file from Kanopi's 1Password."
    echo ""
    read -p "   Do you want to continue without auth.json? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo ""
      echo "❌ Project initialization cancelled"
      echo "   Please add auth.json to the project root and run 'ddev project-init' again"
      exit 1
    fi
    echo ""
    echo "   Continuing with composer install..."
    echo "   Composer may prompt for credentials interactively."
    echo ""
  else
    echo "✅ Authentication configuration found in project root"
  fi
}

# Function to check if autoloader exists
check_autoloader() {
  local vendor_path="${MU_PLUGINS_PATH}/vendor/autoload.php"
  if [ ! -f "$vendor_path" ]; then
    echo "❌ Error: Composer autoloader not found at $vendor_path"
    echo "   The autoloader is required for WordPress to run"
    return 1
  fi
  return 0
}

# Check authentication before composer install
check_auth

# Install Composer dependencies (if composer.json exists).
if [ -f "composer.json" ]; then
  echo -e "\n${construction} ${yellow} Installing Composer dependencies.${NC} ${construction}\n"
  echo -e "${green}${divider}${NC}"

  # Increase timeouts for composer
  export COMPOSER_PROCESS_TIMEOUT=600
  export COMPOSER_HTTP_TIMEOUT=300

  # Try composer install with retry logic
  COMPOSER_SUCCESS=false
  MAX_ATTEMPTS=3
  ATTEMPT=1

  while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$COMPOSER_SUCCESS" = "false" ]; do
    if [ $ATTEMPT -gt 1 ]; then
      echo "⚠️  Composer install attempt $ATTEMPT of $MAX_ATTEMPTS..."
      echo "   Waiting 5 seconds before retry..."
      sleep 5
    fi

    if ddev composer install 2>&1 | tee /tmp/composer-install.log; then
      # Check if autoloader was created successfully
      if check_autoloader; then
        COMPOSER_SUCCESS=true
        echo "✅ Composer dependencies installed successfully"
      else
        echo "⚠️  Composer completed but autoloader not found"
        ATTEMPT=$((ATTEMPT + 1))
      fi
    else
      echo "⚠️  Composer install failed on attempt $ATTEMPT"
      ATTEMPT=$((ATTEMPT + 1))
    fi
  done

  if [ "$COMPOSER_SUCCESS" = "false" ]; then
    echo ""
    echo "❌ Composer install failed after $MAX_ATTEMPTS attempts"
    echo "   Please check authentication credentials and network connection"
    echo "   You can manually run: ddev composer install"
    echo ""
    echo "   Cannot continue without the autoloader."
    echo "   Exiting project initialization."
    exit 1
  fi
fi

# Verify autoloader exists before continuing
if ! check_autoloader; then
  echo ""
  echo "❌ Cannot continue without composer autoloader"
  echo "   Please run: ddev composer install"
  echo "   Then run: ddev project-init"
  exit 1
fi

# Configure WordPress.
ddev project-wp

# Get the database from hosting provider.
ddev db-refresh

# Create admin user.
ddev wp-restore-admin-user

# Install theme.
ddev theme-install

# Install activate.
ddev theme-activate

# Generate login link
ddev wp-open admin

# Complete
echo -e "\n${party} ${yellow} WordPress development environment ready!${NC} ${reverseparty}"
echo -e "Visit ${yellow}${DDEV_PRIMARY_URL}${NC} in a web browser."

echo -e "\nDevelopment commands:"
echo -e "Run ${yellow}${theme_dev_command}${NC} to start theme development with file watching."
echo -e "Run ${yellow}${theme_build_command}${NC} to build production assets."
echo -e "Run ${yellow}${refresh_command}${NC} to pull a fresh database."
echo -e "${green}${divider}${NC}"
