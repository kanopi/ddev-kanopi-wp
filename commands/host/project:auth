#!/usr/bin/env bash

## Description: Authorizes you into DDEV.
## Usage: project:auth
## Example: "ddev project:auth"
## Aliases: project-auth

#ddev-generated

# Load configuration to check hosting provider
source .ddev/scripts/load-config.sh
load_kanopi_config

# Use specific SSH key for WPEngine, all keys for others
if [[ "${HOSTING_PROVIDER}" == "wpengine" ]]; then
    echo "ðŸ” WPEngine detected - using specific SSH key: $WPENGINE_SSH_KEY"

    # Robust tilde and path expansion
    if [[ "$WPENGINE_SSH_KEY" =~ ^\~/ ]]; then
        # Handle ~/path
        SSH_KEY_PATH="$HOME/${WPENGINE_SSH_KEY:2}"
    elif [[ "$WPENGINE_SSH_KEY" =~ ^\~ ]]; then
        # Handle just ~
        SSH_KEY_PATH="$HOME"
    else
        # Use as-is for absolute paths
        SSH_KEY_PATH="$WPENGINE_SSH_KEY"
    fi

    # Remove .pub extension if present
    SSH_KEY_PATH="${SSH_KEY_PATH%.pub}"

    echo "   Resolved to: $SSH_KEY_PATH"

    # For WPEngine, we need to add the specific key to the host SSH agent first
    # then use ddev auth ssh to import it into the container
    echo "ðŸ” Adding SSH key to host agent..."

    # Check if key exists on host
    if [ -f "$SSH_KEY_PATH" ]; then
        echo "âœ… SSH key file found on host"

        # For WPEngine, copy the key and SSH config to container
        echo "ðŸ”‘ Adding WPEngine SSH key and config to container..."
        ddev exec "mkdir -p ~/.ssh && chmod 700 ~/.ssh"
        cat "$SSH_KEY_PATH" | ddev exec "cat > ~/.ssh/$(basename "$SSH_KEY_PATH") && chmod 600 ~/.ssh/$(basename "$SSH_KEY_PATH") && ssh-add ~/.ssh/$(basename "$SSH_KEY_PATH")"

        # Also copy SSH config if it exists, so container knows about host aliases
        if [ -f "$HOME/.ssh/config" ]; then
            echo "ðŸ“‹ Copying SSH config to container..."
            cat "$HOME/.ssh/config" | ddev exec "cat > ~/.ssh/config && chmod 600 ~/.ssh/config"
        fi

        echo "âœ… Loaded only WPEngine SSH key: $(basename "$SSH_KEY_PATH")"
    else
        echo "âš ï¸  SSH key not found on host: $SSH_KEY_PATH"
        echo "   Debugging information:"
        echo "   - Original path: $WPENGINE_SSH_KEY"
        echo "   - Resolved path: $SSH_KEY_PATH"
        echo "   - Files in ~/.ssh/:"
        ls -la ~/.ssh/ 2>/dev/null | grep "$(basename "$SSH_KEY_PATH")" || echo "   Key file not found"
        echo ""
        echo "   Please check your WPENGINE_SSH_KEY configuration"
        echo "   Run 'ddev project:configure' to update it"
        echo "   Falling back to loading all SSH keys..."
        ddev auth ssh
    fi
else
    echo "Loading all SSH keys for $HOSTING_PROVIDER"
    ddev auth ssh
fi
