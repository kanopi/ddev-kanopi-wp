#!/usr/bin/env bash

## Description: Initialize local WordPress development environment.
## Usage: init
## Example: "ddev init"
## OSTypes: darwin,linux

#ddev-generated

#-------------------------- Helper functions ------------------------------

green='\033[0;32m'
yellow='\033[1;33m'
NC='\033[0m'

divider='===================================================\n'
check='\xE2\x9C\x85'
construction='\xF0\x9F\x9A\xA7'
crossmark='\xE2\x9D\x8C'
party='\xF0\x9F\x8E\x88 \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x8A'
reverseparty='\xF0\x9F\x8E\x8A \xF0\x9F\x8E\x89 \xF0\x9F\x8E\x88'
rocket='\xF0\x9F\x9A\x80'
lightning='\xE2\x9A\xA1'
gear='\xEF\xB8\x8F'
key='\xF0\x9F\x94\x91'
lock='\xF0\x9F\x94\x92'
arm='\xF0\x9F\x92\xAA'

# WordPress-specific commands
theme_dev_command='ddev development'
theme_build_command='ddev production'

# Handle Pantheon mu-plugin conflicts early (before any wp-cli commands)
echo -e "\n${construction} ${yellow} Checking for Pantheon mu-plugin conflicts...${NC} ${construction}\n"
PANTHEON_LOADER="web/wp-content/mu-plugins/pantheon-mu-loader.php"
if [ -f "$PANTHEON_LOADER" ]; then
  # Check if the loader tries to load pantheon-mu-plugin
  if grep -q "pantheon-mu-plugin/pantheon.php" "$PANTHEON_LOADER"; then
    # Check if the actual plugin directory exists
    if [ ! -d "web/wp-content/mu-plugins/pantheon-mu-plugin" ]; then
      echo "📝 Found Pantheon mu-plugin loader but plugin directory missing"
      echo "   Disabling to prevent PHP fatal errors in DDEV environment..."
      mv "$PANTHEON_LOADER" "${PANTHEON_LOADER}.disabled"
      echo "✅ Pantheon mu-plugin loader disabled (renamed to .disabled)"
      echo "   This prevents 'Failed to open stream' errors when running WP-CLI commands"
    else
      echo "📝 Pantheon mu-plugin found and appears complete - leaving enabled"
    fi
  else
    echo "📝 Custom pantheon-mu-loader.php found - leaving as-is"
  fi
else
  echo "📝 No Pantheon mu-plugin loader found - no action needed"
fi

# Check for Lefthook (if using git hooks)
LEFTHOOK=$(which lefthook || true)
if [[ "${LEFTHOOK}" == "" ]] && [[ -f ".lefthook.yml" ]]; then
  echo -e "\n${construction} ${yellow} Checking for Lefthook.${NC} ${construction}\n"
  echo -e "If you don't have Lefthook installed, this will ask for your password."
  echo -e "Installing Lefthook."
  ARCH=$(uname -m)
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sudo curl -fsSL -o /usr/local/bin/lefthook "https://github.com/evilmartians/lefthook/releases/download/v1.5.2/lefthook_1.5.2_MacOS_${ARCH}"
  else
    # Linux
    sudo curl -fsSL -o /usr/local/bin/lefthook "https://github.com/evilmartians/lefthook/releases/download/v1.5.2/lefthook_1.5.2_Linux_${ARCH}"
  fi
  echo -e "Setting Lefthook permissions."
  sudo chmod +x /usr/local/bin/lefthook
  echo -e "${green}${divider}${NC}"
fi

#-------------------------- Execution -------------------------------------

echo -e "\n${rocket} ${yellow} Initializing WordPress Development Environment${NC} ${rocket}"
echo -e "${green}${divider}${NC}"

# Initialize Lefthook if config exists
if [[ -f ".lefthook.yml" ]] && [[ "${LEFTHOOK}" != "" ]]; then
  echo -e "\n${construction} ${yellow} Initializing Lefthook.${NC} ${construction}"
  echo -e "This should require no input."
  echo -e "${green}${divider}${NC}"
  lefthook install
fi

# Initialize NVM for Node.js management
echo -e "\n${construction} ${yellow} Initializing NVM...${NC} ${construction}\n"
echo -e "This should require no input."
echo -e "${green}${divider}${NC}"
NVM_DIR="${HOME}/.nvm"
if [[ ! -d "$NVM_DIR" ]]; then
    echo -e "Installing NVM."
    echo -e "${green}${divider}${NC}"
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
fi

# Start DDEV
echo -e "\n${rocket} ${yellow} Starting DDEV.${NC} ${rocket}"
echo -e "${green}${divider}${NC}"
ddev start -y

# Add SSH keys for Pantheon/remote access
echo -e "\n${key} ${yellow} Adding SSH keys.${NC} ${key}"
echo -e "${green}${divider}${NC}"
ddev auth ssh

# Install Composer dependencies (if composer.json exists)
if [ -f "composer.json" ]; then
  echo -e "\n${construction} ${yellow} Installing Composer dependencies...${NC} ${construction}\n"
  echo -e "This should require no input."
  echo -e "${green}${divider}${NC}"
  ddev composer install
fi

# Install WordPress core (if not already installed)
if [ ! -f "web/index.php" ] || [ ! -f "web/wp-load.php" ]; then
  echo -e "\n${construction} ${yellow} Installing WordPress...${NC} ${construction}\n"
  echo -e "${green}${divider}${NC}"
  ddev exec "wp core download --path=/var/www/html/web --allow-root"
  # Only create config if it doesn't exist
  if [ ! -f "web/wp-config.php" ] && [ ! -f "web/wp-config-ddev.php" ]; then
    ddev exec "wp config create --dbname=db --dbuser=db --dbpass=db --dbhost=db --path=/var/www/html/web --allow-root"
  fi
fi

# Install WordPress database (if not already installed)
if [ -f "web/index.php" ]; then
  # Check if WordPress is installed by trying to get the site URL
  WP_INSTALLED=$(ddev exec "wp core is-installed --path=/var/www/html/web --allow-root" 2>/dev/null && echo "true" || echo "false")
  if [ "$WP_INSTALLED" = "false" ]; then
    echo -e "\n${construction} ${yellow} Setting up WordPress database...${NC} ${construction}\n"
    echo -e "${green}${divider}${NC}"
    ddev exec "wp core install --url=\$DDEV_PRIMARY_URL --title='WordPress Site' --admin_user=admin --admin_password=admin --admin_email=admin@example.com --path=/var/www/html/web --allow-root" 2>/dev/null || echo "WordPress database setup completed"
  fi
fi

# Get the database from hosting provider (if configured)
HOSTING_SITE_VALUE=$(ddev exec printenv HOSTING_SITE 2>/dev/null || echo "")
if [ -n "$HOSTING_SITE_VALUE" ]; then
  echo -e "\n${lightning} ${yellow} Refreshing database from hosting provider...${NC} ${lightning}"
  echo -e "${green}${divider}${NC}"
  ddev refresh
fi

# Install theme dependencies and build assets
THEME_PATH=$(ddev exec printenv THEME 2>/dev/null || echo "wp-content/themes/custom/struts")
DOCROOT=$(ddev exec printenv DOCROOT 2>/dev/null || echo "web")
if [ -f "${DOCROOT}/${THEME_PATH}/package.json" ]; then
  echo -e "\n${construction} ${yellow} Installing theme dependencies...${NC} ${construction}\n"
  echo -e "${green}${divider}${NC}"
  ddev exec "cd /var/www/html/${DOCROOT}/${THEME_PATH} && npm install"
  
  echo -e "\n${gear} ${yellow} Building theme assets...${NC} ${gear}"
  echo -e "${green}${divider}${NC}"
  ddev exec "cd /var/www/html/${DOCROOT}/${THEME_PATH} && npm run build"
else
  echo -e "\n${construction} ${yellow} Theme directory not found: ${THEME_PATH}${NC}"
  echo -e "Please ensure your theme is located at the correct path or update THEME environment variable in .ddev/config.yaml"
fi

# Activate theme and restore admin user
echo -e "\n${lock} ${yellow} Configuring WordPress...${NC} ${lock}"
echo -e "${green}${divider}${NC}"

# Activate the custom theme (if configured and WordPress is available)
if [ -f "${DOCROOT}/index.php" ]; then
  THEME_SLUG=$(ddev exec printenv THEMENAME 2>/dev/null || echo "struts")
  ddev exec "wp theme activate ${THEME_SLUG} --allow-root" 2>/dev/null || echo "Theme activation skipped (theme not found)"
else
  echo "Theme activation skipped (WordPress not installed)"
fi

# Restore admin user
ddev restore-admin-user

# Generate login link
echo -e "\n${lock} ${yellow} Generating admin login link...${NC} ${lock}"
echo -e "${green}${divider}${NC}"
ADMIN_USER=$(yq eval '.wordpress.admin_user // "admin"' "$CONFIG_FILE" 2>/dev/null || echo "admin")
LOGIN_URL=$(ddev exec "wp user generate-login-url ${ADMIN_USER} --allow-root" 2>/dev/null || echo "Login link generation failed")

# Complete
echo -e "\n${party} ${yellow} WordPress development environment ready!${NC} ${reverseparty}"
echo -e "Visit ${yellow}${DDEV_PRIMARY_URL}${NC} in a web browser."
if [ "$LOGIN_URL" != "Login link generation failed" ]; then
  echo -e "Admin login: ${yellow}${LOGIN_URL}${NC}"
fi
echo -e "\nDevelopment commands:"
echo -e "Run ${yellow}${theme_dev_command}${NC} to start theme development with file watching."
echo -e "Run ${yellow}${theme_build_command}${NC} to build production assets."
echo -e "Run ${yellow}ddev refresh${NC} to pull fresh database from Pantheon."
echo -e "${green}${divider}${NC}"